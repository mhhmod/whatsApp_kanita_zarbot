<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Business Conversations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            background: #fff;
        }

        /* SIDEBAR - CONTACTS LIST */
        .sidebar {
            width: 360px;
            background: #fff;
            border-right: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-title {
            font-size: 32px;
            font-weight: 800;
            color: #000;
            margin-bottom: 16px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 24px;
            font-size: 15px;
            background: #f0f2f5;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            background: #fff;
            border-color: #00a884;
        }

        .search-input::placeholder {
            color: #999;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .contact-item {
            padding: 12px;
            margin: 0 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contact-item:hover {
            background-color: #f0f2f5;
        }

        .contact-item.active {
            background-color: #e7f3ff;
            border-left: 4px solid #00a884;
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 500;
            color: #000;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-preview {
            font-size: 13px;
            color: #65676b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        .contact-time {
            font-size: 13px;
            color: #999;
            flex-shrink: 0;
        }

        .no-contacts {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        /* CHAT AREA */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .chat-header-text h2 {
            font-size: 15px;
            font-weight: 500;
            color: #000;
            margin: 0;
        }

        .chat-header-text p {
            font-size: 13px;
            color: #65676b;
            margin: 0;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 16px;
            flex-direction: column;
        }

        .chat-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            display: flex;
            margin-bottom: 8px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 55%;
            padding: 8px 12px;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
        }

        .message.sent .message-bubble {
            background: #00a884;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: #e5e5ea;
            color: #000;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            text-align: center;
            width: 100%;
        }

        .message-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* LOADING STATE */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #999;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00a884;
            animation: bounce 1.4s infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .error-message {
            padding: 20px;
            background: #fee;
            color: #c33;
            border-radius: 8px;
            margin: 16px;
            font-size: 14px;
        }

        .success-message {
            padding: 20px;
            background: #efe;
            color: #3c3;
            border-radius: 8px;
            margin: 16px;
            font-size: 14px;
        }

        .refresh-indicator {
            font-size: 12px;
            color: #999;
            padding: 8px 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }

            .message-bubble {
                max-width: 70%;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .messages {
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Chats</div>
                <div class="search-box">
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput" 
                        placeholder="Search contacts..."
                    >
                </div>
            </div>
            <div class="contacts-list" id="contactsList">
                <div class="no-contacts">Loading contacts...</div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area">
            <div id="chatContent" style="display: none; flex: 1; display: flex; flex-direction: column;">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="chat-header-avatar" id="headerAvatar">A</div>
                        <div class="chat-header-text">
                            <h2 id="chatContactName">Contact Name</h2>
                            <p id="chatContactPhone">Phone Number</p>
                        </div>
                    </div>
                </div>
                <div class="messages" id="messagesContainer">
                    <div class="loading">
                        <span>Loading messages</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
                <div class="refresh-indicator" id="refreshIndicator"></div>
            </div>

            <div id="emptyState" style="display: flex;">
                <div class="chat-empty">
                    <div class="chat-empty-icon">üí¨</div>
                    <p>Select a contact to view conversation</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE WITH YOUR SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://lqrpeqhatnancvzqeduz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcnBlcWhhdG5hbmN2enFlZHV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjA1NTQsImV4cCI6MjA4MDQzNjU1NH0.EiCHK-0ha4-NAY9-EeTED_JPMcdTpqCvVJOx2kEZnBU';

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let allContacts = [];
        let filteredContacts = [];
        let selectedContact = null;
        let allMessages = [];
        let lastRefreshTime = null;

        // ============================================
        // SUPABASE CLIENT
        // ============================================
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
            }

            async request(method, path, body = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.key}`,
                        'apikey': this.key,
                    },
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${this.url}/rest/v1${path}`, options);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'API Error');
                }

                return data;
            }

            async select(table, query = '') {
                return this.request('GET', `/${table}?${query}`);
            }
        }

        const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getInitials(name) {
            return name
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        function formatTime(timestamp) {
            try {
                const date = new Date(timestamp);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) {
                return '';
            }
        }

        function formatDate(timestamp) {
            try {
                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date.toDateString() === today.toDateString()) {
                    return 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return 'Yesterday';
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } catch (e) {
                return '';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getRandomColor(seed) {
            // Generate consistent color based on seed
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash) % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        // ============================================
        // FETCH DATA - Load ALL messages from Supabase
        // ============================================
        async function loadAllMessages() {
            try {
                // Load ALL messages from the table (no limit or high limit)
                // Ordered by created_at descending to get newest first for grouping
                const query = 'select=*&order=created_at.desc&limit=10000';
                const data = await supabase.select('messages', query);

                if (!data || data.length === 0) {
                    console.log('No messages found in Supabase');
                    return [];
                }

                // Group messages by contact and get last message for each
                const contactsMap = new Map();
                const messagesMap = new Map(); // Store all messages by phone

                data.forEach(msg => {
                    const phone = msg.contact_phone;

                    // Initialize contact if not exists
                    if (!contactsMap.has(phone)) {
                        contactsMap.set(phone, {
                            phone: msg.contact_phone,
                            name: msg.contact_name || `Contact ${phone}`,
                            lastMessage: msg.message_body || 'No messages',
                            lastMessageTime: msg.created_at,
                        });
                    }

                    // Store all messages by phone for later retrieval
                    if (!messagesMap.has(phone)) {
                        messagesMap.set(phone, []);
                    }
                    messagesMap.get(phone).push(msg);
                });

                // Sort contacts by last message time
                allContacts = Array.from(contactsMap.values()).sort((a, b) => 
                    new Date(b.lastMessageTime) - new Date(a.lastMessageTime)
                );

                // Store messages map globally so we can access it per contact
                window.messagesMap = messagesMap;

                filteredContacts = [...allContacts];
                return data;

            } catch (error) {
                console.error('Error loading all messages:', error);
                showError(`Error loading messages: ${error.message}`);
                return [];
            }
        }

        async function loadMessages(contactPhone) {
            try {
                // Load messages for specific contact, ordered by created_at ascending
                const query = `select=*&contact_phone=eq.${encodeURIComponent(contactPhone)}&order=created_at.asc&limit=1000`;
                const data = await supabase.select('messages', query);
                allMessages = data || [];
                renderMessages();
            } catch (error) {
                console.error('Error loading messages:', error);
                showError(`Error loading messages: ${error.message}`);
            }
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function renderContacts() {
            const contactsList = document.getElementById('contactsList');

            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div class="no-contacts">No contacts found</div>';
                return;
            }

            contactsList.innerHTML = filteredContacts.map(contact => `
                <div class="contact-item ${selectedContact?.phone === contact.phone ? 'active' : ''}" 
                     onclick="selectContact('${contact.phone}', '${contact.name.replace(/'/g, "\\'")}')">
                    <div class="contact-avatar" style="background: linear-gradient(135deg, ${getRandomColor(contact.phone)} 0%, ${getRandomColor(contact.phone + '2')} 100%);">
                        ${getInitials(contact.name)}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${escapeHtml(contact.name)}</div>
                        <div class="contact-preview">${escapeHtml(contact.lastMessage.substring(0, 50))}</div>
                    </div>
                    <div class="contact-time">${formatDate(contact.lastMessageTime)}</div>
                </div>
            `).join('');
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (allMessages.length === 0) {
                messagesContainer.innerHTML = '<div class="loading"><span>No messages yet</span></div>';
                return;
            }

            let currentDate = null;
            let html = '';

            allMessages.forEach((msg) => {
                const msgDate = formatDate(msg.created_at);
                const msgTime = formatTime(msg.created_at);
                const isSent = msg.message_type === 'sent' || msg.direction === 'sent';

                // Add date separator
                if (msgDate !== currentDate) {
                    currentDate = msgDate;
                    html += `<div style="text-align: center; margin: 16px 0; font-size: 12px; color: #999;">${msgDate}</div>`;
                }

                html += `
                    <div class="message-group">
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            <div class="message-bubble">${escapeHtml(msg.message_body || msg.message || '')}</div>
                        </div>
                        <div class="message-time">${msgTime}</div>
                    </div>
                `;
            });

            messagesContainer.innerHTML = html;
            // Scroll to bottom to show latest messages
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        function selectContact(phone, name) {
            selectedContact = { phone, name };
            
            // Update UI
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('chatContent').style.display = 'flex';
            document.getElementById('chatContactName').textContent = name;
            document.getElementById('chatContactPhone').textContent = phone;
            document.getElementById('headerAvatar').textContent = getInitials(name);
            document.getElementById('headerAvatar').style.background = `linear-gradient(135deg, ${getRandomColor(phone)} 0%, ${getRandomColor(phone + '2')} 100%)`;

            // Render contacts to show active state
            renderContacts();

            // Load messages for this contact
            loadMessages(phone);
        }

        function searchContacts(query) {
            const searchTerm = query.toLowerCase();
            filteredContacts = allContacts.filter(contact =>
                contact.name.toLowerCase().includes(searchTerm) ||
                contact.phone.toLowerCase().includes(searchTerm)
            );
            renderContacts();
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchContacts(e.target.value);
        });

        function showError(message) {
            console.error(message);
        }

        function updateRefreshIndicator() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('refreshIndicator').textContent = `Last updated: ${timeStr}`;
        }

        // ============================================
        // AUTO-REFRESH - Check for new messages every 5 seconds
        // ============================================
        function setupAutoRefresh() {
            setInterval(async () => {
                if (selectedContact) {
                    // Refresh current conversation
                    await loadMessages(selectedContact.phone);
                }
                // Refresh contacts list
                await loadAllMessages();
                renderContacts();
                updateRefreshIndicator();
            }, 5000); // Refresh every 5 seconds
        }

        // ============================================
        // INITIALIZATION - Load all data on page open
        // ============================================
        async function init() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                showError('‚ö†Ô∏è Please configure your Supabase credentials in the script (SUPABASE_URL and SUPABASE_ANON_KEY)');
                document.getElementById('contactsList').innerHTML = `
                    <div class="error-message">
                        <strong>Configuration Required:</strong><br>
                        1. Open this HTML file in an editor<br>
                        2. Replace SUPABASE_URL with your Supabase project URL<br>
                        3. Replace SUPABASE_ANON_KEY with your Supabase anon key<br>
                        4. Make sure your messages table has: contact_phone, contact_name, message_body, message_type (sent/received), created_at
                    </div>
                `;
                return;
            }

            console.log('Loading all messages from Supabase...');
            
            // Load ALL messages from Supabase on page open
            await loadAllMessages();
            renderContacts();
            updateRefreshIndicator();

            if (allContacts.length === 0) {
                showError('No conversations found. Make sure your Supabase credentials are correct and you have messages in the table.');
            }

            // Setup auto-refresh to check for new messages
            setupAutoRefresh();
        }

        // Start the app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
